name: DAST - Teste Dinâmico de Segurança (OWASP ZAP)

on:
  push:
    branches: [ "master" ]
  workflow_dispatch:

jobs:
  zap_scan:
    runs-on: ubuntu-latest
    name: Scan de Vulnerabilidades Web

    steps:
      - name: Checkout do Código
        uses: actions/checkout@v3

      # Resolve problema de permissão de arquivo para o ZAP
      - name: Corrigir Permissões
        run: chmod -R 777 .

      # Criar a rede fake para o Docker não reclamar do Wazuh faltando
      - name: Criar Rede do Wazuh (Mock)
        run: docker network create single-node_default

      # Sobe o WAF junto com o App
      - name: Subir Infraestrutura (WAF + App + DB)
        run: |
          # O --build garante que o WAF e o App sejam construídos
          docker compose up -d --build
          sleep 20 # Dá um tempo extra para o Nginx e o Postgres subirem
          docker ps

      # Ataca a porta 80 (WAF) em vez da 5000
      - name: OWASP ZAP Baseline Scan
        uses: zaproxy/action-baseline@v0.9.0
        with:
          target: 'http://localhost:80' # Ataca o Nginx
          artifact_name: 'zap_report'
          fail_action: false # Não quebra o build (apenas gera relatório)